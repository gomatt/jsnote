<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>jsnote</title>
    <script id="source">
      var source = [
        {
          "path" : "start",
          "raw" : "Welcome to [[jsnote]]! You are currently viewing {{page.type}} [[{{page.path}}]]."
        },
        {
          "path" : "system:template:default",
          "raw" : "<div id=\"header\">{{page.path}}</div><br /><div id=\"page_content\">{{page.content}}</div>"
        }
      ];
    </script>
    <script id="config">
      var core = {
        version: "0.1a",
        current: "",
        delimiter: ":",
        action: "::",
        template: "system:template:default"
      };
    </script>
    <script id="core">
      (function() {
        function addListener(obj, eventName, listener) {
          if (obj.addEventListener) {
            obj.addEventListener(eventName, listener, false);
          } else {
            obj.attachEvent("on" + eventName, listener);
          }
        }
        function handleDCL(e) {
          console.log("DOMContentLoaded event fired.");
          init();
        }
        function handleLoad(e) {
          console.log("OnLoad event fired.");
          //init();
        }
        function Book(json) {
          // initialize a blank book
          this.pages = [];
          if (json) this.set(json);
          
          // render default template
          //this.page(core.template).expand();
        }
        Book.prototype = {
          set: function(obj) {
            // AMG? check if the object is an array
            if (Object.prototype.toString.call(obj) === "[object Array]") {
              // run through each item in the array
              for (var index = 0; index < obj.length; ++index) {
                // send each page to be added to this book
                this.import_page(obj[index]);
              }
              return true;
            }
            return false;
          },
          import_page: function(json) {
            // add a new page to the book
            this.pages.push(new Page(json, this));
          },
          index: function(path) {
            // Return the index for the page path provided
            for (var index = 0; index < this.pages.length; ++index) {
              if (this.pages[index].path === path) {
                return index;
              }
            }
            return false;
          },
          page: function(path) {
            // return the page object
            try {
              return this.pages[this.index(path)];
            }
            catch (e) {
              console.log(e.message);
              return false;
            }
          }
        };
        function Page(json, book) {
          // set each key/value pair, if any
          for (var key in json) {
            this[key] = json[key];
          }
          // add new required data if necessary
          this.path = this.path || "new";
          this.type = this.type || "page";
          // add defaults
          this.template = core.template; /* global core */
          this.original = json;
          this.book = book;
        }
        Page.prototype = {
          expand: function () {
            // check if this page is expanded already
            if (!this.content) {
              // replace page placeholders with page values
              this.content = expand(this); // the name 'content' should be changed to accurately represent expansion
            }
            // What happens if already expanded?
            return false;
          }
        };
        
        function expand(page) {
          // look for expressions in page.raw: {{..}} and replace with values
          // if "{{page.title}}" is found, replace with the value from page.title
          // etc.
          
          // now return the content
          
          // but this doesn't work yet so just return the raw content
          return page.raw;
        }
        
        function init() {
          console.log(source);
          var book = new Book(source); /* global source */
          console.log(book);
          book.page("start").expand();
          document.body.innerHTML = book.page("start").output;
        }
        
        // AMG? Where does this need to go?
        if (!window.addEventListener) {
          // eventListeners are not supported
          console.log("Can't add eventListeners; not supported.");
        } else {
          // add eventListeners
          addListener(document, "DOMContentLoaded", handleDCL);
          addListener(window, "load", handleLoad);
        }
      })(this);
    </script>
  </head>
  <body>
  </body>
</html>